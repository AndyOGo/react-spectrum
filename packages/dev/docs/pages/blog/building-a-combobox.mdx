<!-- Copyright 2020 Adobe. All rights reserved.
This file is licensed to you under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License. You may obtain a copy
of the License at http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software distributed under
the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR REPRESENTATIONS
OF ANY KIND, either express or implied. See the License for the specific language
governing permissions and limitations under the License. -->

import {BlogPostLayout} from '@react-spectrum/docs';
export default BlogPostLayout;

---
keywords: [combobox, accessibility, mobile, react spectrum, react, spectrum, interactions, touch]
description: TODO
date: 2020-08-25
author: 'Daniel Lu'
---

# Building a ComboBox

## Intro

As of INSERT DATE HERE, React Spectrum ComboBox has been released as an alpha. For those who may be unfamiliar with a combobox, it is an input field that has a popover menu associated with it. The popover menu contains
a list of values within that a user may select as the value for the combobox and is often filtered to display possible matches to the user's current
input text. Finally, there is a button accompanying the input field used for toggling the open state of the popover menu.

While the above may seem rather straight forward, a combobox contains a significant amount of complexity. Focus needs to remain within the input field
regardless of the popup menu's open state so that a user may continue to filter down the list, but virtual focus needs to be displayed so that items
can be highlighted and selected via keyboard commands as well. A combobox's input value will often diverge and converged from its currently selected value based on
the user's interaction and the combobox's configuration. Cross browser and device support adds additional layers of complexity with each of their behavioral quirks and
interaction models.

In this blog post, we'll be covering the challenges we encountered with regards to ComboBox's mobile experience and accessibility.

## Mobile experience

Like many of our other components, ComboBox displays its popover menu items in a tray when rendered on a mobile device or a smaller screen. This allows for a better mobile experience
since the tray can display more items on the screen and grants users a larger hit area to scroll through. To compensate for the fact that the tray covers the majority of the
screen including the ComboBox, we included an input field within the tray so that end users could still type to filter the available items. So far so good. However,
when we tested the ComboBox's tray input on iOS Safari, the tray's bottom half was covered by the onscreen keyboard and we could not scroll the hidden items into view.

It turns out that when the onscreen keyboard appears, iOS Safari does not shrink the browser window to accommodate it unlike other mobile browsers. Instead, Safari pushes the window upwards and
partially off screen. At the time, we had been relying on `window.innerHeight` to inform us on how tall the tray should be but now we had to find a different way of tracking the available window
space for the tray.

Luckily for us, iOS 13 added support for the VisualViewport API. By querying `window.VisualViewport.height` we could get a reliable measurement of how much vertical space was available on screen. Furthermore, we could track
when the onscreen keyboard was opened or dismissed by listening to the VisualViewport's `resize` event. Leveraging these two allowed us to create a tray that properly adjusts to the presence of iOS onscreen keyboard.
If you'd like to track the visual viewport size in your own app, you can use the `useViewportSize` hook available in the `@react-aria/utils` package.


## Accessibility

- Mention that we used 1.2 spec (link here)
  - mention how we came up against issues with the spec
    - didn't cover our use cases exactly (portal, sections)

- talk about crawling the DOM and aria hidden
  - due to portals we need to hide everything but the input and popover otherwise focus moves from input to the element next to the input in DOM
  - discuss approach taken

- talk about some accessibility tools/browser differences
  - voiceover just didn't really work with aria-activedescendant
    - link to dequeue's combobo
    - list some of the browser specific behaviors
      - link codesandbox made from 1.2 spec with changes to add sections?
  - NVDA
    - didn't announce text cursor movement

- wrap up with links to some of the bugs filed

## Conclusion
